#!/usr/bin/env node
var path=require("path"),fs=require("fs"),crypto=require("crypto"),zlib=require("zlib"),os=require("os"),http=require("http"),https=require("https"),events=require("events"),url=require("url");class CarrierPigeon{constructor(t={}){Object.assign(this,t),void 0==this.strict&&(this.strict=!1),this.reset()}reset(){void 0==this.env&&(this.env=!0),void 0==this.cmds&&(this.cmds=[]),void 0==this.options&&(this.options={}),void 0==this.defaults&&(this.defaults={}),void 0==this.envMap&&(this.envMap={}),void 0==this.flags&&(this.flags={})}cast(t,e){switch(t){case"number":return Number(e);case"file":return path.resolve(e);default:return e}}determineType(t){void 0!=this.options[t].type?this.options[t].type=this.options[t].type:void 0!=this.options[t].default&&(this.options[t].default instanceof Array?this.options[t].type="array":this.options[t].type=typeof this.options[t].default),void 0==this.options[t].type&&(this.options[t].type="string")}command(t){"string"==typeof t&&(t={name:t}),this.cmds.push(t)}commands(...t){t=t.map(t=>("string"==typeof t&&(t={name:t}),t)),this.cmds=t}dashedLine(t=80){return Array(t).join("-")}longest(t,e){for(var i=0,s=0;s<t.length;s++){t[s];i<t[s][e].length&&(i=t[s][e].length)}return i}getColumnSizes(t){for(var e={type:0,flags:0,names:0},i=0;i<t.length;i++){var s=t[i],r="boolean"==this.options[s].type?"":`<${this.options[s].type}>`,n=this.options[s].flags.join(", ");e.type<r.length&&(e.type=r.length),e.flags<n.length&&(e.flags=n.length),e.names<s.length&&(e.names=s.length)}return e}usage(){var t=[],e=Object.keys(this.options);if(this.cmds.length>0){t.push(this.dashedLine(80));for(var i=this.longest(this.cmds,"name"),s=0;s<this.cmds.length;s++){this.cmds[s];var r=["  ",this.column({string:this.cmds[s].name,width:i+15,align:"left"})];void 0!=this.cmds[s].description&&(r.push(this.multilineColumn({text:this.cmds[s].description,width:50-i,padding:i+16})),this.cmds[s].description.length>40&&r.push("\n")),t.push(r.join(""))}t.push(this.dashedLine(80))}var n=this.getColumnSizes(e);for(s=0;s<e.length;s++){var o=e[s],a="boolean"==this.options[o].type?"":`<${this.options[o].type}>`,p=(this.options[o].flags.join(", "),n.type+n.flags+9);t.push([" ",this.column({string:this.options[o].flags.join(", "),width:n.flags+3,align:"left"}),this.column({string:a,width:n.type+3,align:"left"}),this.column({string:o,width:n.names+3,align:"left"}),this.multilineColumn({text:this.options[o].description,width:p-5,padding:p+7})].join(""))}return t}printUsage(){console.log(this.usage().join("\n")),console.log()}column(t){var e=t.string.length,i=t.width-e,s=Array(i).join(" ");return"left"==t.align?[t.string,s].join(""):"right"==t.align?[s,t.string].join(""):void 0}multilineColumn(t){var e=!0,i=t.text.split(" ");function s(e,i,s){return s?e.text.push(i):e.text.push([Array(t.padding+1).join(" "),i].join("")),e}return i.reduce((r,n,o)=>{if(r.line.join(" ").length+n.length+1>t.width){var a=r.line.join(" ");r.line=[n],r=s(r,a,e),e=!1}else r.line.push(n);return i.length==o+1&&(r=s(r,r.line.join(" "),e)),r},{text:[],line:[]}).text.join("\n")}option(t,e={}){var i=this;if(e.variable=t,this.options[t]=e,this.determineType(t),void 0!=e.default&&(this.defaults[t]=e.default),void 0!=e.env&&(this.envMap[t]=e.env),void 0!=e.flags)e.flags.forEach(e=>{i.flags[e]=t});else{var s=t.substring(0,1);void 0==i.flags[`-${s}`]&&(i.flags[`-${s}`]=t),i.flags[`--${t}`]=t,i.options[t].flags=[`-${s}`,`--${t}`]}}negators(){return["--no-","--not-"]}negated(t){return this.negators().map(e=>[e,t].join(""))}isNegated(t){return this.negators().map(e=>-1==t.indexOf(e)).indexOf(!1)>-1}unnegate(t){return this.negators().reduce((e,i)=>(t.indexOf(i)>-1&&e.push(t.replace(i,"")),e),[])[0]}deflag(t){return/^--.+/.test(t)?this.strict||void 0!=this.flags[t]?this.flags[t]:t.replace("--",""):this.flags[t]}isFlag(t){return/^-.+/.test(t)}isBoolean(t){return!!this.existing(t)&&"boolean"==this.options[this.flag(t)].type}flag(t){return this.flags[t]}variable(t){return this.options[this.flags[t]]}existing(t){return void 0!=this.flags[t]}countFlags(t,e){return void 0==t[e]&&(t[e]=0),t[e]=t[e]+1,t}reflag(t){return["--",t].join("")}parse(t=[]){for(var e,i=0,s=JSON.parse(JSON.stringify(this.defaults)),r="cull",n={};i<=t.length-1;)if("cull"==r&&(this.isFlag(t[i])?r="interpret":this.cmds.map(t=>t.name).indexOf(t[i])>-1?(s.command=t[i],t.shift()):t.shift()),"interpret"==r){if(e=t[i],n=this.countFlags(n,e),this.isNegated(e)&&(this.isBoolean(this.reflag(this.unnegate(e)))||0==this.strict))s[this.unnegate(e)]=!1,e=void 0;else if(this.isBoolean(e)||0==this.strict&&0==this.existing(e))s[this.deflag(e)]=!0;else if(this.existing(e)){var o=t[i+=1];s=this.set(s,e,o,n[e])}i+=1}return this.env&&this.forEnv(s),s}isAnArray(t,e){return t[this.flag(e)]instanceof Array}isntAnArray(t,e){return 0==this.isAnArray(t,e)}currentIsDefault(t){return 1==t}shouldBeArray(t){return"array"==this.variable(t).type}shouldConvertToArray(t,e,i){return this.isntAnArray(t,e)&&2==i}set(t,e,i,s){return this.shouldBeArray(e)||this.isAnArray(t,e)&&0==this.strict||this.shouldConvertToArray(t,e,s)&&0==this.strict?(this.shouldConvertToArray(t,e,s)&&(t[this.flag(e)]=[t[this.flag(e)]]),this.currentIsDefault(s)&&(this.shouldBeArray(e)||this.isAnArray(t,e))&&(t[this.flag(e)]=[]),t[this.flag(e)].push(this.cast(this.variable(e).type,i))):t[this.flag(e)]=this.cast(this.variable(e).type,i),t}toEnv(t){"string"==typeof t&&(t=require(path.resolve(t))),Object.assign(process.env,t)}forEnv(t={}){var e=this;Object.keys(this.envMap).forEach(i=>{void 0!=t[i]&&(process.env[e.envMap[i]]=t[i])})}}var post=function(t){var e=url.parse(t.url),i=t.url.indexOf("https")>-1?https:http;e.headers={},e.headers.host=e.host,e.headers.Connection="close",e.headers["Transfer-Encoding"]="Chunked",e.method="POST",e.agent=!1,this.request=i.request(e,function(t){}),this.writable=!0,this.events=new events};post.prototype.write=function(t){this.request.write(t)},post.prototype.end=function(){this.request.end()},post.prototype.on=function(t,e){this.events.on(t,e)},post.prototype.emit=function(t,e){this.events.emit(t,e)},post.prototype.removeListener=function(t,e){this.events.removeListener(t,e)};var createReadable=function(t){return"string"==typeof t?fs.createReadStream(determineInputPath(t)):t},createWriteable=function(t){return"string"==typeof t?fs.createWriteStream(ensureOutputPath(t)):t},ensureFile=function(t){return fs.statSync(t).isFile()},applyDefaults=function(t){var e="sha256",i="aes-256-ctr",s=!1;return void 0==t.stream&&(t.stream=s),t.promise=!t.stream,void 0==t.algorithm&&(t.algorithm=e),void 0==t.cipher&&(t.cipher=i),t.verbose&&(console.log("configuration:"),console.log(t)),t},hashify=function(t="sha256",e,i){return crypto.createHmac(t,e).update(i).digest("hex")},logMessage=function(t){"test"!=process.env.NODE_ENV&&("string"==typeof t?console.log(t):console.log(t.join(" ")))},insideHomeDirectory=function(t){return path.join(os.homedir(),t.slice(1,t.length))},determineInputPath=function(t){return fs.existsSync(t)?t:fs.existsSync(path.join(process.cwd(),t))?path.join(process.cwd(),t):fs.existsSync(t)?t:0==t.indexOf("~")?insideHomeDirectory(t):void 0},ensureOutputPath=function(t){return-1==t.indexOf("/")&&-1==t.indexOf("\\")||0==t.indexOf("/")||0==t.indexOf("\\")?0==t.indexOf("~")?insideHomeDirectory(t):t:path.join(process.cwd(),t)},configure=function(t){return void 0==t.input?t.input=process.stdin:t.input=path.resolve(t.input),void 0==t.output?t.stdout?t.output=process.stdout:"string"==typeof t.input&&(t.input.indexOf(`.${t.extension}`)>-1?t.output=path.resolve(t.input.replace(`.${t.extension}`,"")):t.output=path.resolve([t.input,t.extension].join("."))):t.output=path.resolve(t.output),t},cipher=function(t={}){return t.backwards?void 0!=t.vector?(t.vector=hashify(t.algorithm,t.password,t.vector).slice(0,16),t.password=hashify(t.algorithm,t.password,t.vector).slice(0,32),crypto.createCipheriv(t.cipher,t.password,t.vector)):crypto.createCipher(t.cipher,t.password):(t.vector=hashify(t.algorithm,t.password,t.vector).slice(0,16),t.password=hashify(t.algorithm,t.password,t.vector).slice(0,32),crypto.createCipheriv(t.cipher,t.password,t.vector))},decipher=function(t={}){return t.backwards?void 0!=t.vector?(t.vector=hashify(t.algorithm,t.password,t.vector).slice(0,16),t.password=hashify(t.algorithm,t.password,t.vector).slice(0,32),crypto.createDecipheriv(t.cipher,t.password,t.vector)):crypto.createDecipher(t.cipher,t.password):(t.vector=hashify(t.algorithm,t.password,t.vector).slice(0,16),t.password=hashify(t.algorithm,t.password,t.vector).slice(0,32),crypto.createDecipheriv(t.cipher,t.password,t.vector))},decrypt=function(t){return t=applyDefaults(t),new Promise((e,i)=>{var s=decipher(t),r=createReadable(t.input),n=createWriteable(t.output),o=zlib.createGunzip();if(r.pipe(s).pipe(o),"string"==typeof t.output&&o.pipe(n),t.stdout&&o.pipe(process.stdout),void 0!=t.url){var a=new post({url:t.url});o.pipe(a)}o.on("end",function(){t.promise&&e()}),t.stream&&e(o)})},encrypt=function(t){return t=applyDefaults(t),new Promise((e,i)=>{var s=cipher(t),r=createReadable(t.input),n=createWriteable(t.output),o=zlib.createGzip();if("string"==typeof t.output&&s.pipe(n),t.stdout&&s.pipe(process.stdout),void 0!=t.url){var a=new post({url:t.url});s.pipe(a)}s.on("end",function(){t.promise&&e()}),r.pipe(o).pipe(s),t.stream&&e(s)})},parser=new CarrierPigeon({strict:!0});if(parser.commands({name:"encrypt",description:"encrypt files"},{name:"decrypt",description:"decrypt files"}),parser.option("input",{type:"file",description:"Input File"}),parser.option("output",{type:"file",description:"Output File"}),parser.option("url",{type:"string",description:"Upload Url"}),parser.option("password",{type:"string",description:"Password"}),parser.option("vector",{type:"string",description:"Vector (IV)"}),parser.option("backwards",{default:!1,description:"Backwards Compatible"}),parser.option("cipher",{type:"string",default:"aes-256-ctr",description:"Cipher"}),parser.option("algorithm",{type:"string",default:"sha256",description:"Hashing Algorithm"}),parser.option("stdout",{type:"boolean",flags:["-O","--stdout"],description:"Print to stdout"}),parser.option("extension",{default:"mimi",flags:["-e","--ext","--extension"],description:"File Extension"}),parser.option("stream",{default:!1,description:"Function returns a stream instead of a promise"}),parser.option("verbose",{default:!1,flags:["-vv","--verbose"],description:"Print Logs Verbosely"}),parser.option("help",{type:"boolean",default:!1,description:"Print Usage"}),require.main===module){var options=configure(parser.parse(process.argv));options.help?parser.printUsage():("encrypt"==options.command&&encrypt(options).then(()=>{process.nextTick(()=>{process.exit(0)})}),"decrypt"==options.command&&decrypt(options).then(()=>{process.nextTick(()=>{process.exit(0)})}))}else module.exports={index:{encrypt:encrypt,decrypt:decrypt,parser:parser,configure:configure},carrier_pigeon:CarrierPigeon,cipher:cipher,configure:configure,decipher:decipher,decrypt:decrypt,encrypt:encrypt,internal:{createReadable:createReadable,createWriteable:createWriteable,ensureFile:ensureFile,applyDefaults:applyDefaults,hashify:hashify,logMessage:logMessage,insideHomeDirectory:insideHomeDirectory,determineInputPath:determineInputPath,ensureOutputPath:ensureOutputPath},parser:parser,post:post};